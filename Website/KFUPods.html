<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KFUPods - Smart Sleeping System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
<style>
    /* =========================================
       CSS VARIABLES & RESET
       ========================================= */
    :root {
        --bg-dark: #050508;
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.1);
        --kfupm-green: #008540;
        --tier-s: #FFD700; /* Gold */
        --tier-a: #00FF7F; /* Spring Green */
        --tier-b: #00BFFF; /* Deep Sky Blue */
        --text-main: #ffffff;
        --text-sec: #aaaaaa;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        height: 100vh;
        margin: 0;
        overflow: hidden; /* keep app full-screen with internal scrolls */
    }

    /* Full-screen app, no more ‚Äúmobile width‚Äù */
    #app-container {
        width: 100%;
        height: 100vh;
        background: linear-gradient(to bottom, #0a0a12, #000000);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* =========================================
       UTILITY CLASSES
       ========================================= */
    .hidden { display: none !important; }
    .glass {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
    }
    .btn {
        border: none;
        outline: none;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.96); }

    /* =========================================
       VIEWS (SCREENS)
       ========================================= */
    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        padding-bottom: 80px; /* ŸÖÿ≥ÿßÿ≠ÿ© ŸÑÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¥ÿßÿ¥ÿ© */
        transition: opacity 0.3s ease;
    }

    /* --- LOGIN SCREEN --- */
    #login-view {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 30px;
        z-index: 100;
    }
    .logo-glow {
        width: 250px;
        height: 250px;
        background: radial-gradient(circle, rgba(0,133,64,0.2) 0%, rgba(0,0,0,0) 70%);
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
    }
    .kfupm-logo-text {
        font-size: 40px;
        font-weight: 800;
        letter-spacing: 1px;
    }
    .input-group {
        width: 100%;
        max-width: 420px;
        margin-bottom: 15px;
        background: rgba(255,255,255,0.08);
        padding: 15px;
        border-radius: 12px;
        display: flex;
        align-items: center;
    }
    .input-group input {
        background: transparent;
        border: none;
        color: white;
        font-size: 16px;
        margin-left: 10px;
        width: 100%;
        outline: none;
    }
    .action-btn {
        width: 100%;
        max-width: 420px;
        padding: 15px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 16px;
        margin-top: 10px;
    }
    .btn-green { background: var(--kfupm-green); color: white; }
    .btn-white { background: white; color: black; }

    /* --- MAP VIEW (full screen, circular map) --- */
    #map-view {
        background: #e6e2d3; /* OutOfBounds Color */
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Circle map in the middle of the page */
    .map-circle {
        width: 70vmin;              /* responsive circle */
        height: 70vmin;
        border-radius: 50%;
        background: #f8f8f8;
        border: 10px solid rgba(0,0,0,0.05);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        position: relative;         /* for absolute markers inside */
    }

    /* Grass & Road placeholders using CSS shapes */
    .grass-patch {
        position: absolute;
        background: linear-gradient(to bottom, #ccedcc, #bfe6bf);
        border-radius: 50%;
        filter: blur(1px);
    }
    .road-circle {
        position: absolute;
        top: 6%; left: 6%; right: 6%; bottom: 6%;
        border: 20px solid #dce6f0;
        border-radius: 50%;
    }

    /* Building Marker */
    .building-marker {
        position: absolute;
        width: 90px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transform: translate(-50%, -50%);
        cursor: pointer;
        transition: transform 0.2s;
        z-index: 10;
    }
    .building-marker:active { transform: translate(-50%, -50%) scale(0.95); }
    .marker-number { font-size: 20px; font-weight: 800; color: #333; }
    .marker-name { font-size: 9px; font-weight: 600; color: #555; width: 80%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .status-dot {
        width: 8px; height: 8px; border-radius: 50%;
        position: absolute; top: 6px; right: 6px;
    }

    /* Map UI Overlay ‚Äì fixed title at the very top */
    .map-header {
        position: fixed;      /* <‚Äî stays at top while scrolling */
        top: 10px;
        left: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 20;
        pointer-events: none; /* avoid blocking map click */
    }
    .map-header * {
        pointer-events: auto; /* but allow clicks on buttons */
    }
    .map-pill {
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        padding: 8px 16px;
        border-radius: 20px;
        margin-bottom: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .filter-row { display: flex; gap: 8px; }
    .filter-chip {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: bold;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
    }
    .filter-chip.active { color: black; }
    .support-btn {
        position: fixed;     /* keep support button in corner */
        top: 60px; right: 20px;
        font-size: 24px; color: #333; cursor: pointer; z-index: 20;
    }

    /* --- BUILDING SHEET (Modal) --- */
    .sheet-modal {
        position: fixed;
        bottom: 0; left: 0; width: 100%; height: 90%;
        background: #0b0b10;
        border-radius: 30px 30px 0 0;
        transform: translateY(110%);
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        z-index: 50;
        display: flex;
        flex-direction: column;
    }
    .sheet-modal.open { transform: translateY(0); }
    .sheet-header-img {
        height: 180px;
        background: linear-gradient(to bottom, #1a2a40, #0b0b10);
        position: relative;
        border-radius: 30px 30px 0 0;
        display: flex;
        align-items: flex-end;
        padding: 20px;
    }
    .sheet-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    .close-sheet-btn {
        position: absolute; top: 20px; right: 20px;
        background: rgba(0,0,0,0.5); color: white;
        width: 30px; height: 30px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }

    /* POD Grid */
    .pod-section-title { color: #00BFFF; font-size: 14px; font-weight: bold; margin: 20px 0 10px; }
    .pod-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .pod-card {
        padding: 15px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
    }
    .pod-status {
        font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: bold; color: black; display: inline-block; margin-top: 5px;
    }

    /* --- PAYMENT SHEET --- */
    .pay-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
    .method-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
    .method-pill {
        display: flex; align-items: center; gap: 5px;
        padding: 8px 12px; border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 12px; white-space: nowrap; cursor: pointer;
    }
    .method-pill.selected { background: white; color: black; border-color: white; }

    /* --- SMART CONTROL VIEW --- */
    #smart-control-view { background: linear-gradient(to bottom, #050a14, #081024); }
    .hero-header {
        margin: 20px;
        height: 280px;
        border-radius: 26px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.8)), url('https://via.placeholder.com/400x300/1a1a1a/333333?text=KFUPM+Building');
        background-size: cover;
        position: relative;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 20px;
    }
    .timer-badge {
        position: absolute; bottom: 20px; right: 20px;
        background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2);
        border-radius: 18px; padding: 10px; width: 140px;
    }
    .control-grid {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 0 20px;
    }
    .glass-btn {
        height: 110px;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        border-radius: 20px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
    }
    .glass-btn.active .icon-circle { background: currentColor; box-shadow: 0 0 15px currentColor; }
    .glass-btn.active .icon-circle i { color: white; }
    .icon-circle {
        width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1);
        display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.3s;
    }
    .ac-slider { width: 100%; appearance: none; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
    .ac-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border-radius: 50%; }

    /* --- TOAST --- */
    #toast {
        position: absolute; top: -60px; left: 50%; transform: translateX(-50%);
        background: white; color: black; padding: 12px 24px; border-radius: 25px;
        font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 200; white-space: nowrap;
    }
    #toast.show { top: 40px; }
</style>

</head>
<body>

    <div id="app-container">
        <div id="toast">Notification Message</div>

        <div id="login-view" class="screen">
            <div class="logo-glow">
                <i class="fa-solid fa-building-columns" style="font-size: 80px; color: white;"></i>
            </div>
            <h1 class="kfupm-logo-text">KFUPods</h1>
            <p style="color: gray; margin-bottom: 40px;">Smart Sleeping Pods System</p>

            <div id="login-form-email">
                <div class="input-group">
                    <i class="fa-solid fa-user" style="color: gray;"></i>
                    <input type="text" id="email-input" placeholder="s20xxxx / ID">
                </div>
                <button class="btn action-btn btn-green" onclick="app.sendOTP()">Login</button>
            </div>

            <div id="login-form-otp" class="hidden">
                <div class="input-group">
                    <i class="fa-solid fa-key" style="color: gray;"></i>
                    <input type="number" id="otp-input" placeholder="1234">
                </div>
                <button class="btn action-btn btn-white" onclick="app.verifyLogin()">Verify & Enter</button>
            </div>
        </div>

        <div id="map-view" class="screen hidden">
            <div class="map-header">
                <div class="map-pill">
                    <strong>KFUPM Campus</strong> <span style="font-size:10px; color:#555">Select location</span>
                </div>
                <div class="filter-row">
                    <button class="filter-chip active" style="background:var(--tier-s)" onclick="app.toggleFilter('S')">S-Class</button>
                    <button class="filter-chip active" style="background:var(--tier-a)" onclick="app.toggleFilter('A')">A-Class</button>
                    <button class="filter-chip active" style="background:var(--tier-b)" onclick="app.toggleFilter('B')">B-Class</button>
                </div>
            </div>
            
            <div class="support-btn" onclick="app.switchView('support-view')">
                <i class="fa-solid fa-circle-question"></i>
            </div>

            <div class="map-circle">
                <div class="grass-patch" style="top: 20%; left: 20%; width: 30%; height: 20%;"></div>
                <div class="grass-patch" style="bottom: 25%; right: 20%; width: 25%; height: 15%;"></div>
                <div class="road-circle"></div>
                <div id="buildings-container"></div>
            </div>
        </div>

        <div id="building-sheet" class="sheet-modal">
            <div class="sheet-header-img" id="b-sheet-header">
                <button class="close-sheet-btn" onclick="app.closeBuildingSheet()"><i class="fa-solid fa-xmark"></i></button>
                <div>
                    <h2 id="b-sheet-num" style="font-size: 28px; color:white;"></h2>
                    <p id="b-sheet-name" style="color: #aaa;"></p>
                </div>
            </div>
            <div class="sheet-content" id="b-sheet-pods">
                </div>
        </div>

        <div id="payment-sheet" class="sheet-modal" style="height: 70%; z-index: 60;">
            <div class="sheet-content">
                <div style="width:40px; height:4px; background:#444; margin: 0 auto 20px; border-radius:2px;"></div>
                <h2 style="color: white; margin-bottom: 5px;">Confirm Booking</h2>
                <p id="pay-pod-name" style="color: gray; margin-bottom: 20px;"></p>
                
                <div class="glass" style="padding: 20px; margin-bottom: 20px;">
                    <div class="pay-row">
                        <span style="color:gray;">Rate</span>
                        <span id="pay-rate" style="color:white; font-weight:bold;"></span>
                    </div>
                    <div class="pay-row">
                        <span style="color:gray;">Duration</span>
                        <span id="pay-duration-txt" style="color:white; font-weight:bold;">1 Hour</span>
                    </div>
                    <input type="range" min="1" max="5" value="1" style="width:100%; margin: 10px 0;" oninput="app.updateDuration(this.value)">
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 0;">
                    <div class="pay-row">
                        <span style="font-size: 18px; font-weight:bold;">Total</span>
                        <span id="pay-total" style="font-size: 18px; font-weight:bold; color: var(--kfupm-green);"></span>
                    </div>
                </div>

                <p style="color:gray; font-size:12px; margin-bottom:10px;">Payment Method</p>
                <div class="method-container">
                    <div class="method-pill selected" onclick="app.selectPayment(this)"><i class="fa-brands fa-apple"></i> Apple Pay</div>
                    <div class="method-pill" onclick="app.selectPayment(this)"><i class="fa-solid fa-credit-card"></i> stc pay</div>
                    <div class="method-pill" onclick="app.selectPayment(this)"><i class="fa-solid fa-building-columns"></i> Wallet</div>
                </div>

                <button class="btn btn-green" style="width:100%; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: bold; margin-top: 20px;" onclick="app.confirmBooking()">CONFIRM & PAY</button>
                <button class="btn" style="width:100%; padding: 10px; color: gray; margin-top: 5px;" onclick="document.getElementById('payment-sheet').classList.remove('open')">Cancel</button>
            </div>
        </div>

        <div id="smart-control-view" class="screen hidden">
            <div class="hero-header">
                <div style="position: absolute; top: 20px; left: 20px;">
                    <span id="session-tier-badge" style="background: rgba(255,215,0,0.3); padding: 4px 8px; border-radius: 10px; font-size: 10px; font-weight:bold;">S-Class</span>
                    <h1 id="session-pod-name" style="font-size: 28px;">S21-1</h1>
                    <p id="session-building" style="font-size: 12px; opacity: 0.8;">Adminstration</p>
                </div>

                <div class="timer-badge">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span><i class="fa-solid fa-clock"></i> <span id="timer-display">59:59</span></span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size: 10px; opacity: 0.8;">
                        <span id="door-status"><i class="fa-solid fa-lock-open"></i> Unlocked</span>
                        <span id="light-status"><i class="fa-solid fa-lightbulb"></i> ON</span>
                    </div>
                </div>
            </div>

            <div class="glass" style="margin: 0 20px 20px; padding: 15px;">
                <div class="pay-row">
                    <span>AC Temperature</span>
                    <span id="ac-val" style="font-weight:bold;">22¬∞C</span>
                </div>
                <div style="display:flex; align-items:center; gap: 10px;">
                    <i class="fa-solid fa-snowflake" style="color:#00BFFF"></i>
                    <input type="range" class="ac-slider" min="16" max="28" value="22" oninput="document.getElementById('ac-val').innerText = this.value + '¬∞C'">
                    <i class="fa-solid fa-fire" style="color:orangered"></i>
                </div>
            </div>

            <div class="glass" style="margin: 0 20px 20px; padding: 15px;">
                <div class="pay-row">
                    <span style="font-size:12px; font-weight:bold; color:gray;">SMART ALARM</span>
                    <label class="switch">
                        <input type="checkbox" id="alarm-toggle">
                        <span style="font-size:12px; color:white;">ON/OFF</span>
                    </label>
                </div>
                <input type="time" value="08:00" style="background:transparent; border:1px solid #555; color:white; padding:5px; border-radius:5px;">
            </div>

            <p style="margin: 0 20px 10px; font-size: 12px; font-weight:bold; color:gray;">SYSTEM CONTROL</p>
            <div class="control-grid">
                <button class="glass-btn active" id="btn-lights" onclick="app.toggleSystem('btn-lights')">
                    <div class="icon-circle" style="color: gold;"><i class="fa-solid fa-lightbulb"></i></div>
                    <span style="font-size:10px;">Lights</span>
                </button>
                <button class="glass-btn" id="btn-door" onclick="app.toggleSystem('btn-door')">
                    <div class="icon-circle" style="color: lightgreen;"><i class="fa-solid fa-door-open"></i></div>
                    <span style="font-size:10px;">Door Lock</span>
                </button>
                <button class="glass-btn" id="btn-privacy" onclick="app.toggleSystem('btn-privacy')">
                    <div class="icon-circle" style="color: violet;"><i class="fa-solid fa-eye-slash"></i></div>
                    <span style="font-size:10px;">Privacy</span>
                </button>
                <button class="glass-btn" id="btn-noise" onclick="app.toggleSystem('btn-noise')">
                    <div class="icon-circle" style="color: teal;"><i class="fa-solid fa-ear-listen"></i></div>
                    <span style="font-size:10px;">Quiet</span>
                </button>
                 <button class="glass-btn" id="btn-rgb" onclick="app.toggleSystem('btn-rgb')">
                    <div class="icon-circle" style="color: cyan;"><i class="fa-solid fa-palette"></i></div>
                    <span style="font-size:10px;">RGB</span>
                </button>
                 <button class="glass-btn" id="btn-massage" onclick="app.toggleSystem('btn-massage')">
                    <div class="icon-circle" style="color: pink;"><i class="fa-solid fa-spa"></i></div>
                    <span style="font-size:10px;">Massage</span>
                </button>
            </div>

            <div style="padding: 30px 20px;">
                <button class="btn" style="width:100%; background: #c00; color:white; padding: 15px; border-radius:30px; font-weight:bold;" onclick="app.endSession()">
                    <i class="fa-solid fa-power-off"></i> End Session
                </button>
            </div>
        </div>

        <div id="support-view" class="screen hidden" style="background: #0b0b10; z-index:150;">
            <div style="padding: 20px; display:flex; align-items:center; gap:10px;">
                <button onclick="app.switchView('map-view')" class="btn" style="color:white; font-size:20px;"><i class="fa-solid fa-arrow-left"></i></button>
                <h2>Support</h2>
            </div>
            <div style="padding: 20px;">
                <div class="glass" style="padding: 20px; margin-bottom:15px; display:flex; gap:15px; align-items:center;">
                    <i class="fa-solid fa-message" style="color:cyan; font-size:24px;"></i>
                    <div>
                        <h4>Chat with Operator</h4>
                        <p style="font-size:10px; color:gray;">Send a quick message</p>
                    </div>
                </div>
                <div class="glass" style="padding: 20px; margin-bottom:15px; display:flex; gap:15px; align-items:center;">
                    <i class="fa-solid fa-triangle-exclamation" style="color:orange; font-size:24px;"></i>
                    <div>
                        <h4>Report Issue</h4>
                        <p style="font-size:10px; color:gray;">AC, Light, Noise issues</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DATA MODELS ---
        const buildings = [
            { id: 21, num: "21", name: "Administration", x: 37, y: 59, tiers: ['S'] },
            { id: 17, num: "17", name: "College of GS", x: 20, y: 46, tiers: ['S'] },
            { id: 68, num: "68", name: "Deanships", x: 52, y: 35, tiers: ['S'] },
            { id: 4,  num: "04", name: "Chemistry Eng.", x: 38, y: 30, tiers: ['A'] },
            { id: 75, num: "75", name: "Aerospace Eng.", x: 25, y: 22, tiers: ['A'] },
            { id: 76, num: "76", name: "Petroleum Coll.", x: 68, y: 78, tiers: ['A'] },
            { id: 8,  num: "08", name: "Main Library", x: 50, y: 51, tiers: ['B'] },
            { id: 9,  num: "09", name: "Faculty (SHARQ)", x: 35, y: 49, tiers: ['B'] },
            { id: 22, num: "22", name: "Computing", x: 47, y: 70, tiers: ['B'] },
            { id: 24, num: "24", name: "Business School", x: 37, y: 79, tiers: ['B'] },
            { id: 57, num: "57", name: "Prep Year", x: 74, y: 35, tiers: ['B'] }
        ];

        const prices = { 'S': 20.99, 'A': 15.99, 'B': 7.99 };
        const colors = { 'S': '#FFD700', 'A': '#00FF7F', 'B': '#00BFFF' };

        // --- APP MANAGER LOGIC ---
        const app = {
            state: {
                isLoggedIn: false,
                otpCode: '1234',
                selectedBuilding: null,
                selectedPod: null,
                duration: 1,
                timerInterval: null,
                remainingTime: 0,
                activeFilters: ['S', 'A', 'B']
            },

            // --- Init & Map ---
            init: function() {
                this.renderMapMarkers();
            },

            renderMapMarkers: function() {
                const container = document.getElementById('buildings-container');
                container.innerHTML = '';
                
                buildings.forEach(b => {
                    const hasTier = b.tiers.some(t => this.state.activeFilters.includes(t));
                    if(!hasTier) return;

                    // Get main tier color
                    const tier = b.tiers[0]; 
                    const color = colors[tier];

                    const el = document.createElement('div');
                    el.className = 'building-marker glass';
                    el.style.left = b.x + '%';
                    el.style.top = b.y + '%';
                    el.style.backgroundColor = color + 'dd'; // Hex opacity
                    el.onclick = () => this.openBuildingSheet(b);
                    
                    el.innerHTML = `
                        <div class="status-dot" style="background:${Math.random() > 0.3 ? 'lime' : 'red'}"></div>
                        <span class="marker-number">${b.num}</span>
                        <span class="marker-name">${b.name}</span>
                    `;
                    container.appendChild(el);
                });
            },

            toggleFilter: function(tier) {
                const idx = this.state.activeFilters.indexOf(tier);
                if (idx > -1) this.state.activeFilters.splice(idx, 1);
                else this.state.activeFilters.push(tier);
                
                // Toggle visual class
                const btns = document.querySelectorAll('.filter-chip');
                btns.forEach(btn => {
                    if(btn.innerText.includes(tier)) btn.classList.toggle('active');
                });

                this.renderMapMarkers();
            },

            // --- Auth ---
            sendOTP: function() {
                const email = document.getElementById('email-input').value;
                if(!email) return this.showToast("Enter ID first!");
                
                this.showToast("Code sent: 1234 üì≤");
                document.getElementById('login-form-email').classList.add('hidden');
                document.getElementById('login-form-otp').classList.remove('hidden');
            },

            verifyLogin: function() {
                const code = document.getElementById('otp-input').value;
                if (code === '1234') {
                    this.state.isLoggedIn = true;
                    this.switchView('map-view');
                    this.showToast("Welcome Back! üëã");
                } else {
                    this.showToast("Invalid Code ‚ùå");
                }
            },

            // --- Building Sheet ---
            openBuildingSheet: function(building) {
                this.state.selectedBuilding = building;
                document.getElementById('b-sheet-num').innerText = "Building " + building.num;
                document.getElementById('b-sheet-name').innerText = building.name;
                
                // Generate Pods Logic
                const podContainer = document.getElementById('b-sheet-pods');
                podContainer.innerHTML = '';
                
                // Simulate data structure from Swift (S, A, B tiers in building)
                const tiers = building.tiers;
                tiers.forEach(tier => {
                    const title = document.createElement('div');
                    title.className = 'pod-section-title';
                    title.innerText = tier === 'S' ? 'ROYAL SUITES (S-Class)' : tier === 'A' ? 'PREMIUM (A-Class)' : 'STANDARD (B-Class)';
                    podContainer.appendChild(title);

                    const grid = document.createElement('div');
                    grid.className = 'pod-grid';

                    for(let i=1; i<=4; i++) {
                        const isBusy = (i % 3 === 0);
                        const pName = tier + building.num + "-" + i;
                        const card = document.createElement('div');
                        card.className = 'pod-card';
                        card.style.opacity = isBusy ? '0.5' : '1';
                        card.onclick = () => !isBusy && this.openPaymentSheet(pName, tier);
                        
                        card.innerHTML = `
                            <div style="display:flex; justify-content:space-between; color:white; font-weight:bold;">
                                <span>${pName}</span>
                                <i class="fa-solid fa-${tier === 'S' ? 'crown' : 'leaf'}" style="color:${colors[tier]}"></i>
                            </div>
                            <div class="pod-status" style="background:${isBusy ? 'red' : 'lime'}">${isBusy ? 'BUSY' : 'OPEN'}</div>
                            <div style="font-size:10px; color:gray; margin-top:5px;">${prices[tier]} SAR/hr</div>
                        `;
                        grid.appendChild(card);
                    }
                    podContainer.appendChild(grid);
                });

                document.getElementById('building-sheet').classList.add('open');
            },

            closeBuildingSheet: function() {
                document.getElementById('building-sheet').classList.remove('open');
            },

            // --- Payment ---
            openPaymentSheet: function(podName, tier) {
                this.state.selectedPod = { name: podName, tier: tier, price: prices[tier] };
                this.state.duration = 1;

                document.getElementById('pay-pod-name').innerText = podName + " ‚Ä¢ Building " + this.state.selectedBuilding.num;
                document.getElementById('pay-rate').innerText = this.state.selectedPod.price + " SAR/hr";
                this.updateDuration(1);
                
                document.getElementById('payment-sheet').classList.add('open');
            },

            updateDuration: function(val) {
                this.state.duration = parseInt(val);
                document.getElementById('pay-duration-txt').innerText = val + " Hour(s)";
                const total = (this.state.selectedPod.price * this.state.duration).toFixed(2);
                document.getElementById('pay-total').innerText = total + " SAR";
            },

            selectPayment: function(el) {
                document.querySelectorAll('.method-pill').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
            },

            confirmBooking: function() {
                document.getElementById('payment-sheet').classList.remove('open');
                this.closeBuildingSheet();
                
                this.showToast("Booking Confirmed ‚úÖ");
                
                // Start Session
                setTimeout(() => {
                    this.startSession();
                }, 500);
            },

            // --- Active Session ---
            startSession: function() {
                this.switchView('smart-control-view');
                
                // Update UI Info
                document.getElementById('session-pod-name').innerText = this.state.selectedPod.name;
                document.getElementById('session-tier-badge').innerText = this.state.selectedPod.tier + "-Class";
                document.getElementById('session-tier-badge').style.backgroundColor = colors[this.state.selectedPod.tier] + '66';
                document.getElementById('session-building').innerText = this.state.selectedBuilding.name;

                // Timer Logic
                this.state.remainingTime = this.state.duration * 3600; // seconds
                this.updateTimerDisplay();
                
                if(this.state.timerInterval) clearInterval(this.state.timerInterval);
                
                this.state.timerInterval = setInterval(() => {
                    this.state.remainingTime--;
                    this.updateTimerDisplay();
                    
                    if(this.state.remainingTime <= 0) {
                        this.endSession();
                    }
                }, 1000); // 1 sec fast forward for demo? No, let's keep it real.
            },

            updateTimerDisplay: function() {
                const m = Math.floor(this.state.remainingTime / 60);
                const s = this.state.remainingTime % 60;
                document.getElementById('timer-display').innerText = 
                    `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            },

            toggleSystem: function(btnId) {
                const btn = document.getElementById(btnId);
                btn.classList.toggle('active');
                
                if(btnId === 'btn-door') {
                   const locked = btn.classList.contains('active'); // active means locked in Swift code
                   document.getElementById('door-status').innerHTML = locked ? 
                       '<i class="fa-solid fa-lock" style="color:lime"></i> Locked' : 
                       '<i class="fa-solid fa-lock-open" style="color:red"></i> Unlocked';
                }
            },

            endSession: function() {
                clearInterval(this.state.timerInterval);
                this.showToast("Session Ended üëã");
                this.switchView('map-view');
            },

            // --- Helpers ---
            switchView: function(viewId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
            },

            showToast: function(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        // Initialize Map
        app.init();

    </script>
</body>
</html>